{% extends 'main/base.html' %}
{% load static %}
{% load l10n %}

{% block body_class %}has-ai-assistant{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'main/announcement_assets/css/select2.min.css' %}">
<link rel="stylesheet" href="{% static 'main/announcement_assets/css/slick.css' %}">
<link rel="stylesheet" href="{% static 'main/announcement_assets/css/jquery-ui.css' %}">
<link rel="stylesheet" href="{% static 'main/announcement_assets/css/main.css' %}">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<style>
    #detail-map {
        height: 200px;
        width: 100%;
        border-radius: 5px;
        z-index: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5 mb-5">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">Головна</a></li>
            
            {% if announcement.category.parent %}
                <li class="breadcrumb-item">
                    <a href="{% url 'announcement:list' %}?category={{ announcement.category.parent.slug }}">
                        {{ announcement.category.parent.name }}
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    <a href="{% url 'announcement:list' %}?category={{ announcement.category.slug }}">
                        {{ announcement.category.name }}
                    </a>
                </li>
            {% else %}
                <li class="breadcrumb-item active" aria-current="page">
                    <a href="{% url 'announcement:list' %}?category={{ announcement.category.slug }}">
                        {{ announcement.category.name }}
                    </a>
                </li>
            {% endif %}
        </ol>
    </nav>
    <div class="row">
        {# Main Content (Left Column) #}
        <div class="col-lg-8">
            {# Image Carousel #}
            <div id="announcementCarousel" class="carousel slide bg-light rounded overflow-hidden mb-4"
                data-bs-ride="carousel"
                style="min-height: 400px; max-height: 600px; display: flex; align-items: center; justify-content: center;">
                <div class="carousel-inner">
                    {% for image in announcement.images.all %}
                    <div class="carousel-item {% if forloop.first %}active{% endif %}" style="max-height: 600px;">
                        <img src="{{ image.image.url }}" class="d-block w-100" alt="Image for {{ announcement.title }}"
                            style="object-fit: contain; max-height: 600px;">
                    </div>
                    {% empty %}
                    <div class="carousel-item active">
                        <div class="d-flex align-items-center justify-content-center">
                            <img src="{% static 'main/announcement_assets/img/without_photo.png' %}"
                                class="d-block w-100" style="object-fit: contain; max-height: 600px;">
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% if announcement.images.count > 1 %}
                <button class="carousel-control-prev" type="button" data-bs-target="#announcementCarousel"
                    data-bs-slide="prev">
                    <span class="carousel-control-prev-icon bg-dark rounded-circle p-3" aria-hidden="true"
                        style="opacity: 0.5;"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#announcementCarousel"
                    data-bs-slide="next">
                    <span class="carousel-control-next-icon bg-dark rounded-circle p-3" aria-hidden="true"
                        style="opacity: 0.5;"></span>
                    <span class="visually-hidden">Next</span>
                </button>
                {% endif %}
            </div>

            {# Badges / Status #}
            <div class="mb-4">
                <p class="text-muted small mb-2">Опубліковано {{ announcement.created_at|date:"d E Y" }} р.</p>
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <h1 class="mb-0">{{ announcement.title }}</h1>
                    {% if user.is_authenticated %}
                    <a href="{% url 'announcement:toggle_favorite' announcement.pk %}?next={{ request.get_full_path|urlencode }}"
                        class="text-decoration-none js-favorite-toggle">
                        {% if announcement.id in favorite_ids %}
                        <i class="fas fa-heart text-danger fs-4"></i>
                        {% else %}
                        <i class="far fa-heart text-muted fs-4"></i>
                        {% endif %}
                    </a>
                    {% else %}
                    <a href="{% url 'accounts:login' %}?next={% url 'announcement:detail' announcement.pk %}"
                        class="text-decoration-none">
                        <i class="far fa-heart text-muted fs-4"></i>
                    </a>
                    {% endif %}
                </div>
                <h2 class="fw-bold mb-3">
                    {{ announcement.price|default:"Договірна" }}
                    {% if announcement.price %}грн.{% endif %}
                    {% if announcement.is_negotiable %}
                    <small class="text-muted fs-6 fw-normal">Торг можливий</small>
                    {% endif %}
                </h2>
            </div>

            {# Attributes/Tags #}
            <div class="card mb-4 border-0 bg-light">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <strong>Категорія:</strong> {{ announcement.category.get_full_name }}
                        </div>
                        <div class="col-md-6 mb-2">
                            <strong>Стан:</strong> {{ announcement.get_condition_display|default:"-" }}
                        </div>
                    </div>
                </div>
            </div>

            {# Description #}
            <div class="mb-5">
                <h3 class="fw-bold mb-3">ОПИС</h3>
                <p class="fs-5" style="white-space: pre-line;">{{ announcement.description }}</p>
            </div>

            <hr>
            <div class="d-flex justify-content-between text-muted small">
                <span>ID: {{ announcement.id }}</span>
                <span>Переглядів: {{ announcement.views_count }}</span>
                <span class="text-muted"><i class="fas fa-heart text-danger me-1"></i>Кількість доданих в обране: {{ announcement.favorites.count }}</span>
            </div>

        </div>

        {# Sidebar (Right Column) #}
        <div class="col-lg-4">
            {# User Card #}
            <div class="card shadow-sm mb-3">
                <div class="card-body">
                    <h6 class="text-uppercase text-muted small mb-3">КОРИСТУВАЧ</h6>
                    <div class="d-flex align-items-center mb-3">
                        <div class="flex-shrink-0">
                            {% if announcement.seller.profile_photo %}
                            <img src="{{ announcement.seller.profile_photo.url }}" class="rounded-circle" width="60"
                                height="60" alt="{{ announcement.seller.username }}">
                            {% else %}
                            <img src="{% static 'main/img/avatar.png' %}" class="rounded-circle" width="60"
                                height="60" alt="Default avatar">
                            {% endif %}
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h5 class="mb-0 fw-bold">
                                {% if announcement.seller.first_name %}
                                {{ announcement.seller.first_name }} {{ announcement.seller.last_name }}
                                {% else %}
                                {{ announcement.seller.username }}
                                {% endif %}
                            </h5>
                            <small class="text-muted">на сайті з {{ announcement.seller.date_joined|date:"F Y" }}
                                р.</small>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        {% if user.is_authenticated and user == announcement.seller %}
                        <a class="btn btn-dark btn-lg"
                            href="{% url 'announcement:edit' announcement.pk %}">Редагувати</a>
                        {% elif user.is_authenticated and user != announcement.seller %}
                        <a class="btn btn-dark btn-lg"
                            href="{% url 'chat:start' announcement.seller.username %}">Повідомлення</a>
                        {% else %}
                        <a class="btn btn-dark btn-lg"
                            href="{% url 'accounts:login' %}?next={{ request.path }}">Повідомлення</a>
                        {% endif %}
                        <button class="btn btn-outline-dark btn-lg"
                            onclick="this.textContent='{{ announcement.seller.phone_number|default:'Номер не вказано' }}'">
                            Показати телефон
                        </button>
                    </div>

                    <div class="mt-3 text-center">
                        <a href="{% url 'announcement:list' %}?seller={{ announcement.seller.username|urlencode }}"
                            class="text-decoration-none">Усі оголошення автора <i
                                class="bi bi-chevron-right"></i></a>
                    </div>
                </div>
            </div>

            {# Location Card #}
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="text-uppercase text-muted small mb-3">МІСЦЕЗНАХОДЖЕННЯ</h6>
                    <div class="d-flex align-items-start">
                        <i class="bi bi-geo-alt-fill text-dark fs-4 me-2"></i>
                        <div>
                            <h6 class="mb-0 fw-bold">{{ announcement.address }}</h6>
                        </div>
                    </div>
                    {# Map Placeholder #}
                    {% if announcement.latitude and announcement.longitude %}
                    <div id="detail-map" class="mt-3"></div>
                    <script>
                        document.addEventListener('DOMContentLoaded', function () {
                            const lat = {{ announcement.latitude|unlocalize }};
                            const lng = {{ announcement.longitude|unlocalize }};
                            const map = L.map('detail-map').setView([lat, lng], 13);
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                attribution: '&copy; OpenStreetMap contributors'
                            }).addTo(map);
                            L.marker([lat, lng]).addTo(map)
                                .bindPopup('{{ announcement.address|escapejs }}');
                        });
                    </script>
                    {% else %}
                    <div class="bg-light mt-3 rounded d-flex align-items-center justify-content-center"
                        style="height: 100px;">
                        <span class="text-muted">Карта недоступна</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="ai-assistant"
     data-ai-assistant
     data-endpoint="{% url 'assistant:message' %}"
     data-inactive-img="{% static 'main/img/inactive.png' %}"
     data-active-img="{% static 'main/img/active.png' %}"
     data-generate-img="{% static 'main/img/generate.gif' %}"
     data-speaks-img="{% static 'main/img/speaks.gif' %}">
    <div class="ai-assistant__panel" role="dialog" aria-label="AI assistant">
        <div class="ai-assistant__header">
            <div class="ai-assistant__title">
                <div>Чат з AI-лисичкою</div>
            </div>
            <button class="ai-assistant__close" type="button" aria-label="Закрити">×</button>
        </div>
        <div class="ai-assistant__body">
            <div class="ai-assistant__messages">
                <div class="ai-assistant__bubble">
                    Привіт! Я ваш AI-помічник<br>Чим можу допомогти?
                </div>
            </div>
        </div>
        <div class="ai-assistant__footer">
            <div class="ai-assistant__input-wrap">
                <input class="ai-assistant__input" type="text" placeholder="Напишіть повідомлення...">
                <button class="ai-assistant__send" type="button" aria-label="Надіслати">
                    <i class="fa fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
    <button class="ai-assistant__toggle" type="button" aria-label="Відкрити помічника">
        <img src="{% static 'main/img/assistant/inactive.png' %}" alt="AI">
    </button>
</div>
{% endblock %}

{% block extra_js %}
<script>
    (function () {
        var widget = document.querySelector('[data-ai-assistant]');
        if (!widget) return;
        var toggle = widget.querySelector('.ai-assistant__toggle');
        var closeBtn = widget.querySelector('.ai-assistant__close');

        function closeWidget() {
            widget.classList.remove('is-open');
        }

        var input = widget.querySelector('.ai-assistant__input');
        var sendBtn = widget.querySelector('.ai-assistant__send');
        var messages = widget.querySelector('.ai-assistant__messages');
        var endpoint = widget.getAttribute('data-endpoint');

        function getCookie(name) {
            var value = '; ' + document.cookie;
            var parts = value.split('; ' + name + '=');
            if (parts.length === 2) return parts.pop().split(';').shift();
            return '';
        }

        function setAvatarState(state) {
            if (!avatar) return;
            var map = {
                inactive: widget.getAttribute('data-inactive-img'),
                active: widget.getAttribute('data-active-img'),
                generate: widget.getAttribute('data-generate-img'),
                speaks: widget.getAttribute('data-speaks-img')
            };
            if (map[state]) {
                avatar.src = map[state];
            }
        }

        function appendBubble(text, isUser) {
            var bubble = document.createElement('div');
            bubble.className = 'ai-assistant__bubble' + (isUser ? ' ai-assistant__bubble--user' : '');
            bubble.innerHTML = text;
            messages.appendChild(bubble);
            messages.scrollTop = messages.scrollHeight;
            return bubble;
        }

        function appendItems(items) {
            if (!items || !items.length) return;
            var list = document.createElement('div');
            list.className = 'ai-assistant__items';
            items.forEach(function (item) {
                var card = document.createElement('a');
                card.className = 'ai-assistant__item';
                card.href = item.url;
                card.innerHTML =
                    (item.image ? '<img src="' + item.image + '" alt="">' : '') +
                    '<div>' +
                    '<div class="ai-assistant__item-title">' + item.title + '</div>' +
                    '<div class="ai-assistant__item-price">' +
                    (item.price ? (item.price + ' грн') : 'Договірна') +
                    '</div></div>';
                list.appendChild(card);
            });
            messages.appendChild(list);
            messages.scrollTop = messages.scrollHeight;
        }

        function sendMessage() {
            var text = (input.value || '').trim();
            if (!text || !endpoint) return;
            input.value = '';
            appendBubble(text, true);

            sendBtn.disabled = true;
            var typing = appendBubble('Думаю над відповіддю...', false);
            setAvatarState('generate');

            fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({ message: text }),
                credentials: 'same-origin',
            })
            .then(function (resp) {
                if (!resp.ok) throw new Error('Request failed');
                return resp.json();
            })
            .then(function (data) {
                typing.remove();
                setAvatarState('speaks');
                appendBubble(data.reply || 'Ось що знайшов(ла).', false);
                if (data.questions && data.questions.length) {
                    appendBubble('Уточніть, будь ласка: ' + data.questions.join(' '), false);
                }
                appendItems(data.items || []);
                setTimeout(function () {
                    setAvatarState('active');
                }, 800);
            })
            .catch(function () {
                typing.remove();
                appendBubble('Вибачте, сталася помилка. Спробуйте ще раз.', false);
                setAvatarState('active');
            })
            .finally(function () {
                sendBtn.disabled = false;
            });
        }

        toggle.addEventListener('click', function () {
            widget.classList.toggle('is-open');
            setAvatarState(widget.classList.contains('is-open') ? 'active' : 'inactive');
        });
        closeBtn.addEventListener('click', function () {
            closeWidget();
            setAvatarState('inactive');
        });
        sendBtn.addEventListener('click', sendMessage);
        input.addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendMessage();
            }
        });
        var avatar = widget.querySelector('.ai-assistant__toggle img');
        setAvatarState('inactive');
    })();
</script>
{% endblock %}
