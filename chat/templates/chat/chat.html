{% extends "main/base.html" %}

{% block title %}Chat{% endblock %}

{% block extra_css %}
<style>
    .chat-shell {
        background: #f6f8fb;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
    }

    .chat-list .list-group-item {
        border: 0;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        transition: background 0.2s ease, color 0.2s ease;
    }

    .chat-list .list-group-item:hover {
        background: rgba(6, 187, 204, 0.1);
    }

    .chat-list .list-group-item.active {
        background: #06bbcc;
        color: #fff;
    }

    .chat-list .list-group-item.active small,
    .chat-list .list-group-item.active .text-muted {
        color: rgba(255, 255, 255, 0.8) !important;
    }

    .chatbox {
        background: #fff;
        border-radius: 16px;
        padding: 16px;
        height: 60vh;
        overflow-y: auto;
    }

    .chat-message {
        display: flex;
        margin-bottom: 12px;
    }

    .chat-message.sender {
        justify-content: flex-end;
    }

    .message-bubble {
        max-width: 75%;
        padding: 12px 16px;
        border-radius: 14px;
        background: rgba(6, 187, 204, 0.1);
        color: #1f2a37;
    }

    .chat-message.sender .message-bubble {
        background: #06bbcc;
        color: #fff;
        border-bottom-right-radius: 4px;
    }

    .chat-message.receiver .message-bubble {
        background: #f1f4f8;
        border-bottom-left-radius: 4px;
    }

    .message-meta {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        font-size: 12px;
        margin-top: 6px;
        opacity: 0.8;
    }

    .chat-input {
        background: #fff;
        border-radius: 16px;
        padding: 12px;
        margin-top: 16px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-5">
    <div class="container" id="chat-page" data-current-username="{{ request.user.username }}">
        <div class="chat-shell">
            <div class="row g-4">
                <div class="col-12 col-lg-4">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-primary text-white d-flex align-items-center justify-content-between">
                            <span>Повідомлення</span>
                        </div>
                        <div class="card-body p-0">
                            <div id="chat-list"
                                hx-get="{% url 'chat:list' %}"
                                hx-trigger="load, refresh"
                                hx-target="#chat-list"
                                hx-swap="innerHTML"
                                hx-include="#current-room">
                                {% include "chat/partials/chat_list.html" %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-lg-8">
                    <div id="chat-panel">
                        {% include "chat/partials/chat_panel.html" %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/htmx.org@1.9.12"></script>
<script>
    function initChatPanel() {
        const page = document.querySelector("#chat-page");
        const currentUsername = page ? page.dataset.currentUsername : "";
        const panel = document.querySelector("#chat-panel");
        const roomInput = document.querySelector("#current-room");
        const roomName = roomInput ? roomInput.value : "";
        const chatbox = panel ? panel.querySelector("#chatbox") : null;
        const input = panel ? panel.querySelector("#my_input") : null;
        const submitButton = panel ? panel.querySelector("#submit_button") : null;
        const deleteButton = panel ? panel.querySelector("[data-chat-delete]") : null;

        function scrollToBottom() {
            if (chatbox) {
                chatbox.scrollTop = chatbox.scrollHeight;
            }
        }

        scrollToBottom();

        if (deleteButton) {
            deleteButton.addEventListener("click", function (event) {
                if (!confirm("Delete this chat and all messages?")) {
                    event.preventDefault();
                }
            });
        }

        if (!roomName) {
            if (window.chatSocket) {
                window.chatSocket.close();
                window.chatSocket = null;
            }
            return;
        }

        if (window.chatSocket) {
            window.chatSocket.close();
        }

        const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
        window.chatSocket = new WebSocket(
            wsScheme + "://" + window.location.host + "/ws/chat/" + roomName + "/"
        );

        window.chatSocket.onopen = function () {
            console.log("WebSocket connected.");
        };
        window.chatSocket.onclose = function () {
            console.log("WebSocket closed.");
        };

        if (input) {
            input.onkeyup = function (e) {
                if (e.keyCode == 13) {
                    e.preventDefault();
                    submitButton.click();
                }
            };
        }

        if (submitButton) {
            submitButton.onclick = function () {
                const messageInput = input.value.trim();

                if (messageInput.length == 0) {
                    alert("Add some input first or press the Send button!");
                } else {
                    window.chatSocket.send(
                        JSON.stringify({
                            message: messageInput,
                            username: currentUsername,
                            room_name: roomName,
                        })
                    );
                    input.value = "";
                    const chatList = document.querySelector("#chat-list");
                    if (chatList) {
                        htmx.trigger(chatList, "refresh");
                    }
                }
            };
        }

        window.chatSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);

            if (data.type === "read_receipt") {
                const statusEl = document.querySelector(
                    `.read-status[data-message-id="${data.message_id}"]`
                );
                if (statusEl) {
                    statusEl.innerHTML = "&#10003;&#10003;";
                }
                return;
            }

            if (data.message && data.sender) {
                const noMessages = document.querySelector(".no-messages");
                if (noMessages) {
                    noMessages.style.display = "none";
                }

                const div = document.createElement("div");
                div.className =
                    "chat-message " +
                    (data.sender === currentUsername
                        ? "sender"
                        : "receiver");

                const bubble = document.createElement("div");
                bubble.className = "message-bubble";

                const text = document.createElement("div");
                text.className = "message-text";
                text.textContent = data.message;

                const meta = document.createElement("div");
                meta.className = "message-meta";

                const time = document.createElement("span");
                const date = new Date();
                time.textContent = date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
                meta.appendChild(time);

                if (data.sender === currentUsername) {
                    const status = document.createElement("span");
                    status.className = "read-status";
                    if (data.message_id) {
                        status.setAttribute("data-message-id", data.message_id);
                    }
                    status.innerHTML = "&#10003;";
                    meta.appendChild(status);
                }

                bubble.appendChild(text);
                bubble.appendChild(meta);
                div.appendChild(bubble);
                if (chatbox) {
                    chatbox.appendChild(div);
                }
                scrollToBottom();

                const lastMessage = document.querySelector(
                    ".list-group-item.active .last-message"
                );
                if (lastMessage) {
                    lastMessage.textContent =
                        data.sender === currentUsername
                            ? "You: " + data.message
                            : data.message;

                    const timestamp = document.querySelector(
                        ".list-group-item.active .timestamp"
                    );
                    if (timestamp) {
                        timestamp.textContent = time.textContent;
                    }

                    const chats = document.querySelectorAll(".list-group-item");
                    const chatsArray = Array.from(chats);
                    const chatsSorted = chatsArray.sort((a, b) => {
                        const aTime = a.querySelector("small").innerHTML;
                        const bTime = b.querySelector("small").innerHTML;
                        return aTime < bTime ? 1 : -1;
                    });

                    const contacts = document.querySelector(".chat-list");
                    if (contacts) {
                        contacts.innerHTML = "";
                        chatsSorted.forEach((chat) => {
                            contacts.appendChild(chat);
                        });
                    }
                } else {
                    console.error("No active chat selected");
                }
                const chatList = document.querySelector("#chat-list");
                if (chatList) {
                    htmx.trigger(chatList, "refresh");
                }
            } else {
                console.error("Message or sender data is missing:", data);
            }
        };
    }

    document.addEventListener("DOMContentLoaded", initChatPanel);

    document.body.addEventListener("htmx:afterSwap", function (event) {
        if (event.target.id === "chat-panel") {
            initChatPanel();
            const chatList = document.querySelector("#chat-list");
            if (chatList) {
                htmx.trigger(chatList, "refresh");
            }
        }
    });
</script>
{% endblock %}
