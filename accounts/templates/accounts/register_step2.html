{% extends 'main/base.html' %}
{% load static %}

{% block title %}Реєстрація - Крок 2{% endblock %}

{% block content %}
<div class="container py-5 auth-page register-step">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm p-4 p-md-5" style="border-radius: 20px;">
                <div class="progress-container">
                    <div class="progress-steps">
                        <div class="progress-step">
                            <div class="step-circle completed">✓</div>
                            <span class="step-label completed">Основна інформація</span>
                        </div>
                        <div class="progress-step">
                            <div class="step-circle active">2</div>
                            <span class="step-label active">Місто</span>
                        </div>
                        <div class="progress-step">
                            <div class="step-circle">3</div>
                            <span class="step-label">Фото</span>
                        </div>
                    </div>
                </div>

                <h2 class="text-center mb-1">Оберіть ваше місто</h2>
                <p class="text-center mb-4" style="color: var(--gray);">Крок 2 з 3: Це допоможе нам показувати
                    релевантні пропозиції</p>

                <form method="post" novalidate>
                    {% csrf_token %}

                    <div class="form-group mb-4">
                        <label class="form-label">{{ form.city.label }}</label>
                        <div class="city-autocomplete">
                            {{ form.city }}
                            <div class="city-suggestions" id="city-suggestions-step2"></div>
                        </div>
                        {% if form.city.errors %}
                        {% for error in form.city.errors %}
                        <span class="form-error">{{ error }}</span>
                        {% endfor %}
                        {% endif %}
                        <small style="color: var(--gray); display: block; margin-top: 0.5rem;">
                            Це поле необов'язкове. Ви можете пропустити цей крок.
                        </small>
                    </div>

                    <div class="button-group d-flex gap-3 mt-4">
                        <button type="submit" name="skip"
                            class="btn btn-outline-secondary rounded-pill flex-grow-1 py-3">
                            Пропустити
                        </button>
                        <button type="submit" class="btn btn-primary rounded-pill flex-grow-1 py-3">
                            Продовжити
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script>
    (function () {
        const cityInput = document.getElementById('{{ form.city.id_for_label }}');
        const suggestions = document.getElementById('city-suggestions-step2');
        if (!cityInput || !suggestions) {
            return;
        }

        cityInput.setAttribute('autocomplete', 'off');

        const dataUrl = "{% static 'main/data/ua_cities.json' %}";
        const escapeHtml = (value) => value.replace(/[&<>"']/g, (char) => ({
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;'
        }[char]));
        const setOpen = (open) => {
            suggestions.classList.toggle('show', open);
        };

        let cities = [];

        const render = (matches) => {
            const options = matches.map((city) => (
                `<button type="button" class="city-option" data-value="${escapeHtml(city)}">${escapeHtml(city)}</button>`
            ));
            suggestions.innerHTML = options.join('');
            setOpen(matches.length > 0);
        };

        const updateList = () => {
            const query = cityInput.value.trim().toLowerCase();
            const matches = query
                ? cities.filter((city) => city.toLowerCase().includes(query)).slice(0, 20)
                : cities.slice(0, 10);
            render(matches);
        };

        fetch(dataUrl)
            .then((response) => response.json())
            .then((data) => {
                cities = Array.isArray(data) ? data : [];
            })
            .catch(() => {
                cities = [];
                setOpen(false);
            });

        suggestions.addEventListener('click', (event) => {
            const option = event.target.closest('.city-option');
            if (!option) return;
            cityInput.value = option.dataset.value || '';
            setOpen(false);
            cityInput.focus();
        });

        cityInput.addEventListener('input', updateList);
        cityInput.addEventListener('focus', updateList);

        document.addEventListener('click', (event) => {
            if (!suggestions.contains(event.target) && event.target !== cityInput) {
                setOpen(false);
            }
        });
    })();
</script>
{% endblock %}